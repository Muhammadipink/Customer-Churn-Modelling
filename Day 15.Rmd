---
title: "A/B Testing Analysis"
author: "Raden Muhammad Hadi"
date: "2/25/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r}
library(tidyverse)
library(pwr)
```

# Load Library

```{r}
# read dataset
df <- read_csv("https://raw.githubusercontent.com/hadimaster65555/dataset_for_teaching/main/dataset/marketing_campaign_experiment/marketing-clean.csv")
```
```{r}
df
```

# A/B Testing

## Data Inspection and Exploration

Check null values inside data

```{r}
df %>% 
  glimpse()
```

```{r}
df %>% 
  is.na() %>% 
  colSums()
```

Check number of sample of each variant

```{r}
df %>% 
  count(variant) %>% 
  ggplot(aes(x = variant, y = n, label = n, fill=variant)) + 
  geom_col() + 
  geom_text(nudge_y = 50) +
  theme_minimal()
```

Variant vs Converted

```{r}
df %>% 
  filter(converted == TRUE) %>% 
  count(variant) %>%
  ggplot(aes(x = variant, y = n, label = n, fill=variant)) + 
  geom_col() + 
  geom_text(nudge_y = 5) +
  theme_minimal() +
  labs(
    x = "Variant",
    y = "Total Conversion",
    title = "Total Conversion vs Variant"
  )
```

We can observe that total conversion of "Personalization" is greater than "Control". It seems that there's significant effect of variant B compared to A, but need to prove it to statistical test.


```{r}
df %>% 
  filter(converted == TRUE) %>% 
  ggplot(mapping = aes(x=language_preferred, fill=converted)) + 
  geom_bar(stat = "count", position = "dodge") +
  theme_minimal() +
  facet_wrap(vars(variant))
```

```{r}
df %>% 
  filter(variant == "personalization") %>% 
  ggplot(aes(x = "", y = variant, fill = age_group)) + theme_bw() + 
  geom_bar(stat = "identity") + 
  coord_polar("y", start = 0)
```



```{r}
df %>% 
  filter(variant == "personalization") %>%
  ggplot(mapping = aes(x=variant, fill=age_group)) + 
  geom_bar(stat = "count", position = "dodge") +
  theme_minimal() +
  labs(
    x = "Age Group",
    y = "Conversion Count",
    title = "Total Conversion vs Variant"
  )
```

```{r}
ggplot(data = df, mapping = aes(x=age_group, fill=converted)) + 
  geom_bar(stat = "count", position = "dodge") +
  theme_minimal() +
  labs(
    x = "Age Group",
    y = "Conversion Count",
    title = "Total Conversion vs Variant"
  ) + 
  facet_grid(vars(variant))
```

```{r}
df %>%
  ggplot(mapping = aes(x= converted, fill= marketing_channel)) + 
  geom_bar(stat = "count", position = "dodge") +
  theme_minimal() +
  facet_grid(vars(variant))
```
Urutan Top 3 Marketing Channel berdasarkan rate conversion pada grup user yang diberi iklan personalisasi adalah, Instagram, Facebook dan House Ads.

```{r}
df %>% 
  filter(variant == "personalization") %>% 
  ggplot(mapping = aes(x=age_group, fill=marketing_channel)) + 
  geom_bar(stat = "count", position = "dodge") +
  theme_minimal()
```


```{r}
df %>% 
  filter(variant == "personalization", converted == TRUE) %>% 
  ggplot(mapping = aes(x=age_group, fill=marketing_channel)) + 
  geom_bar(stat = "count", position = "dodge") +
  theme_minimal()
```


```{r}
df %>% 
  mutate(date_subscribed = lubridate::as_date(lubridate::mdy(date_subscribed))) %>%
  mutate(date_canceled = lubridate::as_date(lubridate::mdy(date_canceled))) -> df
```

```{r}
df
```


```{r}
df %>% 
  mutate(length_of_stay = df$date_canceled - df$date_subscribed) -> df
```

```{r}
df$length_of_stay <- as.numeric(df$length_of_stay)
```

```{r}
df$length_of_stay %>% 
  summary()
```

```{r}
df
```


```{r}
df %>% 
  filter(length_of_stay > 0) %>% 
  group_by(variant) %>% 
  summarize(
    mean_length_of_stay = mean(length_of_stay)
  )
```

```{r}
df %>% 
  filter(length_of_stay > 0) %>% 
  ggplot(aes(x = length_of_stay, fill = variant)) + 
  geom_histogram(bins = 10) +
  theme_minimal() +
  geom_vline(xintercept = 51.45247, linetype = "dashed", col = "red") +
  geom_vline(xintercept = 48.33766, col = "cyan") +
  labs()
```


```{r}
df %>% 
  filter(length_of_stay > 0) %>% 
  ggplot(aes(x = length_of_stay, fill = variant)) + 
  geom_boxplot() +
  theme_minimal() +
  labs(
    x = "Variant",
    y = "Length of Stay",
    title = "Length of Stay vs Variant"
  ) + 
  coord_flip()
```




```{r}
# from raw_data
df %>% 
  # select variant and converted column
  select(variant, converted, age_group) %>%
  filter(converted == TRUE) %>% 
  # cross-tabulation
  table() 
```



## Using Proportion Test (Chi-Square) for Count Data

Calculate conversion for each variant

```{r}
df %>% 
  count(variant, converted) %>% 
  pivot_wider(names_from = converted, values_from = n) %>% 
  mutate(conv_percent = `TRUE` * 100/(`FALSE` + `TRUE`)) %>% 
  mutate(total_sampel = `FALSE` + `TRUE`) -> conv_calculation
```

Check calculation result

```{r}
conv_calculation
```

Calculate uplift of B

```{r}
conv_calculation %>% 
  select(variant, conv_percent) %>% 
  pivot_wider(names_from = variant, values_from = conv_percent) %>% 
  mutate(uplift = (personalization - control) * 100/ control) %>% 
  pull(uplift) -> treatment_uplift
```

Check uplift

```{r}
treatment_uplift
```

Do chi-squared test

```{r}
# from raw_data
df %>% 
  # select variant and converted column
  select(variant, converted) %>% 
  # cross-tabulation
  table() %>%
  # change table position
  .[,c(2,1)] %>% 
  # proportion test
  prop.test(conf.level = .95, correct = F)
```

**Summary**

- Variant A has 20 conversions compared to variant B has 37
- Relative uplift of B (5.07%) from A (2.77%) around 82.72%
- p-value computed is 0.02448 < 0.05, hence there is strong statistical significance in test results. Then, we should reject null hypothesis and proceed to launch variant B for all users


## Using Linear Models

**Using Logistic Regression for Binary Data**

Define data for modeling

```{r}
df %>% 
  mutate(
    converted = as.numeric(converted),
    variant = factor(variant)
  ) %>% 
  select(variant, converted) -> data_for_model
```

check data for model

```{r}
data_for_model %>% 
  head()
```

Create logistic regression model

```{r}
log_reg <- glm(converted ~ variant, family = "binomial", data = data_for_model)
```

Summarize model

```{r}
summary(log_reg)
```

**Summary**






